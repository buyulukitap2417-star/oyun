<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oyun | SDÜ Oryantiring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: white; margin: 0; overflow: hidden; height: 100vh; touch-action: none; user-select: none; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .digital { font-family: 'JetBrains Mono', monospace; text-shadow: 0 0 10px #9b1c31; }
        
        #mapLayer { position: fixed; inset: 0; z-index: 100; background: #020617; transform: translateY(100%); transition: transform 0.5s ease; display: flex; flex-direction: column; }
        #mapLayer.open { transform: translateY(0); }
        #vp { width: 100%; flex-grow: 1; overflow: hidden; position: relative; background: #000; cursor: grab; }
        #canvas { position: absolute; transform-origin: 0 0; will-change: transform; }

        /* Telsiz Butonu */
        #radioBtn { position: fixed; bottom: 24px; right: 24px; z-index: 150; transition: all 0.3s; }
        .ptt-active { background: #ef4444 !important; scale: 1.2; box-shadow: 0 0 30px #ef4444; }
        #radioStatus { position: fixed; bottom: 90px; right: 24px; font-size: 10px; font-weight: 800; text-transform: uppercase; color: #ef4444; display: none; }
    </style>
</head>
<body class="flex flex-col items-center justify-center">

    <!-- GİRİŞ EKRANI -->
    <div id="loginUI" class="fixed inset-0 z-[300] flex items-center justify-center bg-slate-950 px-6">
        <div class="max-w-md w-full glass p-8 rounded-[2.5rem] border-t-4 border-red-700 shadow-2xl text-center">
            <img src="https://r.resimlink.com/p5fEz.png" class="w-20 mx-auto mb-6">
            <h1 class="text-xl font-black uppercase mb-8">YARIŞMACI GİRİŞİ</h1>
            <input type="text" id="codeIn" placeholder="TAKIM KODU" class="w-full bg-black/40 border border-white/10 rounded-xl py-4 px-6 text-center text-xl font-bold outline-none uppercase text-red-500 mb-4 focus:border-red-600">
            <button onclick="login()" class="w-full py-4 bg-red-700 text-white rounded-xl font-black uppercase tracking-widest active:scale-95 transition-all">SİSTEME BAĞLAN</button>
        </div>
    </div>

    <!-- OYUN PANELİ -->
    <div id="dashUI" class="hidden w-full h-full flex flex-col p-4 space-y-4">
        <!-- Dashboard içeriği (Takım adı, Sayaç vb.) -->
        <div class="flex justify-between gap-4">
            <div class="flex-1 glass rounded-2xl p-4">
                <h2 id="teamN" class="text-xs font-black uppercase truncate text-left text-white">---</h2>
                <p id="statL" class="text-[9px] font-bold text-slate-500 uppercase text-left">Hazır</p>
            </div>
            <div class="flex-1 glass rounded-2xl p-4 text-center border-b-2 border-red-700">
                <div id="clock" class="text-2xl font-black digital text-white">00:00:00</div>
                <p class="text-[9px] text-red-500 font-bold uppercase tracking-widest">AKTİF SÜRE</p>
            </div>
        </div>

        <div class="flex-1 glass rounded-[2.5rem] flex flex-col items-center justify-center text-center p-8">
            <div id="wait" class="space-y-4">
                <i data-lucide="clock" class="w-16 h-16 text-slate-700 mx-auto"></i>
                <h4 class="text-lg font-black uppercase text-slate-400 tracking-tighter">BAŞLANGIÇ BEKLENİYOR</h4>
            </div>
            <div id="go" class="hidden space-y-8">
                <div class="w-20 h-20 bg-red-700/10 border-2 border-red-700 rounded-full flex items-center justify-center animate-pulse mx-auto shadow-2xl">
                    <i data-lucide="map" class="text-red-600"></i>
                </div>
                <button onclick="setMap(true)" class="px-12 py-5 bg-red-700 rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl">HARİTAYI AÇ</button>
            </div>
        </div>
    </div>

    <!-- SESLİ TELSİZ BUTONU -->
    <div id="radioStatus">KONUŞUN...</div>
    <button id="radioBtn" class="hidden p-6 bg-[#9b1c31] text-white rounded-full shadow-2xl border-4 border-white/10 select-none touch-none">
        <i data-lucide="mic"></i>
    </button>

    <!-- HARİTA KATMANI -->
    <div id="mapLayer">
        <div class="p-4 flex justify-between glass border-none"><h2 class="text-xs font-black uppercase">Harita</h2><button onclick="setMap(false)"><i data-lucide="chevron-down"></i></button></div>
        <div id="vp"><div id="canvas"><img id="mImg" src="https://hxdmiamcednlzoklkxnu.supabase.co/storage/v1/object/public/map/map.png" class="pointer-events-none"></div></div>
    </div>

    <audio id="sfxStatic" src="https://assets.mixkit.co/sfx/preview/mixkit-radio-noise-3058.mp3"></audio>

    <script>
        const SUPABASE_URL = 'https://hxdmiamcednlzoklkxnu.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_2lmWYp5Pkvn_BsADVHPKug_KK9n8v2-';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let team = null, timerInt = null, mediaRecorder;
        let audioChunks = [];

        async function login() {
            const code = document.getElementById('codeIn').value.trim().toUpperCase();
            const { data } = await supabaseClient.from('registrations').select('*').eq('team_code', code).single();
            if(data) {
                team = data;
                document.getElementById('teamN').innerText = team.team_name;
                document.getElementById('loginUI').classList.add('hidden');
                document.getElementById('dashUI').classList.remove('hidden');
                document.getElementById('radioBtn').classList.remove('hidden');
                sync();
                setupRealtime();
                // Audio Context Unlock
                document.getElementById('sfxStatic').play().catch(() => {}); 
            }
        }

        function setupRealtime() {
            supabaseClient.channel('radio').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'radio_messages' }, (p) => {
                if (p.new.audio_url && p.new.sender_type === 'admin') {
                    if (p.new.receiver_id === 'all' || p.new.receiver_id === team.id) {
                        playAdminVoice(p.new.audio_url);
                    }
                }
            }).subscribe();

            supabaseClient.channel('game').on('postgres_changes', { event:'UPDATE', schema:'public', table:'registrations', filter:`id=eq.${team.id}` }, (p) => {
                team = p.new; sync();
            }).subscribe();
        }

        function playAdminVoice(url) {
            document.getElementById('sfxStatic').play();
            const audio = new Audio(url);
            audio.play();
        }

        // --- BAS KONUŞ MANTIĞI ---
        const rb = document.getElementById('radioBtn');
        const rs = document.getElementById('radioStatus');

        async function startRec() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = uploadVoice;
                mediaRecorder.start();
                rb.classList.add('ptt-active');
                rs.style.display = 'block';
            } catch(e) { alert("Mikrofon izni yok!"); }
        }

        function stopRec() {
            if(mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                rb.classList.remove('ptt-active');
                rs.style.display = 'none';
            }
        }

        async function uploadVoice() {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const fileName = `team_${team.id}_${Date.now()}.webm`;
            const { data, error } = await supabaseClient.storage.from('radio_voice').upload(fileName, blob);
            if(!error) {
                const { publicUrl } = supabaseClient.storage.from('radio_voice').getPublicUrl(fileName);
                await supabaseClient.from('radio_messages').insert({
                    sender_type: 'team',
                    sender_id: team.id,
                    receiver_id: 'admin',
                    sender_name: team.team_name,
                    audio_url: publicUrl,
                    content: '[Sesli Mesaj]'
                });
            }
        }

        rb.onpointerdown = e => { e.preventDefault(); startRec(); };
        window.onpointerup = stopRec;

        function sync() {
            if(timerInt) clearInterval(timerInt);
            const run = team.is_timer_running;
            document.getElementById('wait').classList.toggle('hidden', run);
            document.getElementById('go').classList.toggle('hidden', !run);
            if(run) {
                timerInt = setInterval(() => {
                    const s = Math.floor((Date.now() - new Date(team.timer_started_at).getTime()) / 1000) + Number(team.elapsed_seconds || 0);
                    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
                    document.getElementById('clock').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
                }, 1000);
            }
        }

        function setMap(b) { document.getElementById('mapLayer').classList.toggle('open', b); }
        lucide.createIcons();
    </script>
</body>
</html>

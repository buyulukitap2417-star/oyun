<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oyun | SDÜ Oryantiring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- QR Okuma Kütüphanesi -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #020617; 
            color: white; 
            margin: 0; 
            overflow: hidden; 
            height: 100vh; 
            touch-action: none;
            /* Mavi seçmeyi tamamen engelleme */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .digital { font-family: 'JetBrains Mono', monospace; text-shadow: 0 0 10px #9b1c31; }
        
        #mapLayer { 
            position: fixed; inset: 0; z-index: 100; background: #020617; 
            transform: translateY(100%); transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; flex-direction: column; 
        }
        #mapLayer.open { transform: translateY(0); }
        
        #vp { width: 100%; flex-grow: 1; overflow: hidden; position: relative; background: #000; cursor: grab; }
        #canvas { position: absolute; transform-origin: 0 0; will-change: transform; pointer-events: auto; }
        
        .map-point {
            position: absolute; width: 32px; height: 32px; background: #9b1c31; 
            border: 2px solid white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 11px; color: white;
            box-shadow: 0 0 15px rgba(155, 28, 49, 0.6); 
            transform: translate(-50%, -50%); 
            z-index: 50; /* Noktaların en üstte olmasını garantile */
            pointer-events: auto; /* Tıklanabilirliği zorla */
            cursor: pointer;
        }
        .map-point:active { transform: translate(-50%, -50%) scale(0.9); }
        .map-point.start { background: #2563eb; box-shadow: 0 0 15px rgba(37, 99, 235, 0.6); }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px); z-index: 200;
            display: none; align-items: center; justify-content: center; padding: 1.5rem;
        }
        .modal-overlay.active { display: flex; }

        #reader { width: 100% !important; border-radius: 1rem; overflow: hidden; border: none !important; }
        
        .st-view-iframe {
            width: 100%; height: 300px; border-radius: 1rem; border: none;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center">

    <!-- GİRİŞ EKRANI -->
    <div id="loginUI" class="fixed inset-0 z-[300] flex items-center justify-center bg-slate-950 px-6 text-center">
        <div class="max-w-md w-full glass p-8 rounded-[2.5rem] border-t-4 border-red-700 shadow-2xl">
            <img src="https://r.resimlink.com/p5fEz.png" class="w-20 mx-auto mb-6">
            <h1 class="text-xl font-black uppercase mb-8 text-white">YARIŞMACI GİRİŞİ</h1>
            <input type="text" id="codeIn" placeholder="TAKIM KODU" class="w-full bg-black/40 border border-white/10 rounded-xl py-4 px-6 text-center text-xl font-bold outline-none uppercase text-red-500 mb-4 focus:border-red-600">
            <button onclick="login()" class="w-full py-4 bg-red-700 text-white rounded-xl font-black uppercase tracking-widest active:scale-95 transition-all shadow-lg">BAŞLAT</button>
        </div>
    </div>

    <!-- OYUN DASHBOARD -->
    <div id="dashUI" class="hidden w-full h-full flex flex-col p-4 space-y-4">
        <div class="flex justify-between gap-4">
            <div class="flex-1 glass rounded-2xl p-4">
                <h2 id="teamN" class="text-xs font-black uppercase truncate text-left text-white">---</h2>
                <p id="statL" class="text-[9px] font-bold text-slate-500 uppercase text-left">Bağlı</p>
            </div>
            <div class="flex-1 glass rounded-2xl p-4 text-center border-b-2 border-red-700">
                <div id="clock" class="text-2xl font-black digital text-white">00:00:00</div>
                <p class="text-[9px] text-red-500 font-bold uppercase tracking-widest mt-1">GÜNCEL SÜRE</p>
            </div>
        </div>

        <div class="flex-1 glass rounded-[2.5rem] flex flex-col items-center justify-center text-center p-8">
            <div id="wait" class="space-y-4">
                <i data-lucide="clock" class="w-16 h-16 text-slate-700 mx-auto"></i>
                <h4 class="text-lg font-black uppercase text-slate-400">BAŞLANGIÇ BEKLENİYOR</h4>
                <p class="text-slate-500 text-xs italic">Hakem süreyi başlattığında harita açılacaktır.</p>
            </div>
            <div id="go" class="hidden space-y-8">
                <div class="w-24 h-24 bg-red-700/10 border-2 border-red-700 rounded-full flex items-center justify-center animate-pulse mx-auto shadow-2xl">
                    <i data-lucide="navigation" class="text-red-600 w-12 h-12"></i>
                </div>
                <button onclick="setMap(true)" class="px-12 py-5 bg-red-700 rounded-2xl font-black uppercase text-xs tracking-widest shadow-2xl active:scale-95 transition-all">HARİTAYI AÇ</button>
            </div>
        </div>
    </div>

    <!-- HARİTA KATMANI -->
    <div id="mapLayer">
        <div class="p-6 flex justify-between items-center glass border-none bg-slate-900/50 backdrop-blur-md">
            <div>
                <h2 class="font-black text-xs uppercase tracking-widest text-white">SAHA HARİTASI</h2>
                <p class="text-[9px] text-red-500 font-bold uppercase">Noktalara tıklayarak seçenekleri görün</p>
            </div>
            <button onclick="setMap(false)" class="p-3 bg-white/5 rounded-xl hover:bg-red-600/20 transition-colors"><i data-lucide="chevron-down" class="text-white"></i></button>
        </div>
        
        <div id="vp">
            <div id="canvas">
                <img id="mImg" src="https://hxdmiamcednlzoklkxnu.supabase.co/storage/v1/object/public/map/map.png" class="pointer-events-none" alt="Map">
                <div id="pts" class="pointer-events-auto"></div>
            </div>
        </div>

        <div class="absolute bottom-10 left-1/2 -translate-x-1/2 flex gap-4 z-[110]">
            <button onclick="zoom(1.4)" class="p-5 glass rounded-full shadow-2xl active:scale-90 transition-all text-white"><i data-lucide="zoom-in"></i></button>
            <button onclick="resetM()" class="p-5 glass rounded-full shadow-2xl active:scale-90 transition-all text-white"><i data-lucide="maximize-2"></i></button>
            <button onclick="zoom(0.7)" class="p-5 glass rounded-full shadow-2xl active:scale-90 transition-all text-white"><i data-lucide="zoom-out"></i></button>
        </div>
    </div>

    <!-- SEÇENEK MODALI -->
    <div id="pointModal" class="modal-overlay">
        <div class="glass w-full max-w-sm p-8 rounded-[2.5rem] text-center space-y-6">
            <div class="p-4 bg-red-600/10 rounded-full w-16 h-16 mx-auto flex items-center justify-center text-red-600">
                <i data-lucide="map-pin" class="w-8 h-8"></i>
            </div>
            <div>
                <h3 id="modalPointName" class="text-sm font-black uppercase text-white mb-2 leading-tight">---</h3>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Lütfen bir işlem seçin</p>
            </div>
            <div class="space-y-3">
                <button id="btnTask" class="w-full py-4 bg-red-700 text-white rounded-xl font-black uppercase text-xs tracking-widest flex items-center justify-center gap-3 active:scale-95 transition-all">
                    <i data-lucide="qr-code"></i> GÖREVİ AÇ (QR)
                </button>
                <button id="btnLoc" class="w-full py-4 glass border border-white/10 text-white rounded-xl font-bold uppercase text-xs tracking-widest flex items-center justify-center gap-3 active:scale-95 transition-all">
                    <i data-lucide="eye"></i> KONUMU GÖR
                </button>
                <button onclick="closeModals()" class="w-full py-3 text-slate-500 text-[10px] font-bold uppercase tracking-[0.2em] hover:text-white transition-colors">KAPAT</button>
            </div>
        </div>
    </div>

    <!-- QR SCANNER MODALI -->
    <div id="qrModal" class="modal-overlay">
        <div class="glass w-full max-w-md p-6 rounded-[2rem] text-center space-y-4">
            <h3 class="text-sm font-black uppercase text-white">QR KODU OKUTUN</h3>
            <div id="reader"></div>
            <button onclick="closeScanner()" class="w-full py-4 bg-slate-800 text-white rounded-xl font-bold uppercase text-xs">VAZGEÇ</button>
        </div>
    </div>

    <!-- İÇERİK MODALI -->
    <div id="contentModal" class="modal-overlay">
        <div class="glass w-full max-w-lg p-6 rounded-[2rem] text-center relative">
            <button onclick="closeModals()" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i data-lucide="x"></i></button>
            <div id="contentBody" class="mt-4 space-y-4"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://hxdmiamcednlzoklkxnu.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_2lmWYp5Pkvn_BsADVHPKug_KK9n8v2-';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let team = null, timerInt = null, html5QrCode = null;
        let sc = 1, minSc = 1, tx = 0, ty = 0, isD = false, sx, sy;
        let selectedPoint = null;

        const points = [
            { id: 0, x: 475, y: 320, name: "Eğitim Fakültesi", type: "start", task: "Hoş geldiniz! Yarışma burada başlıyor. Koordinatları takip edin!", loc: "SDÜ+Eğitim+Fakültesi" },
            { id: 1, x: 222, y: 220, name: "SDÜ 29 Ekim Olimpik Yüzme Havuzu", task: "Havuzun derinliklerinde değil, sorunun mantığında gizli her şey.", loc: "SDÜ+29+Ekim+Yüzme+Havuzu" },
            { id: 2, x: 590, y: 210, name: "ISUBÜ Orman Fakültesi", task: "Ağaçların arasından fısıldayan bir matematik problemi var.", loc: "ISUBÜ+Orman+Fakültesi" },
            { id: 3, x: 200, y: 520, name: "SDÜ Bilgi Merkezi", task: "Bilginin kalbindesin. Sessizce soruyu oku ve cevabı şifrele.", loc: "SDÜ+Kütüphane" },
            { id: 4, x: 410, y: 450, name: "SDÜ Academi Yaşam Merkezi", task: "Yaşamın hızıyla matematiğin hızını birleştir.", loc: "SDÜ+Yaşam+Merkezi" },
            { id: 5, x: 490, y: 530, name: "Doğu Yerleşkesi Merkez Durağı", task: "Duraktaki bekleyen her saniye bir denklemdir.", loc: "SDÜ+Merkez+Durak" },
            { id: 6, x: 375, y: 285, name: "SDÜ Spor Bilimleri Fakültesi", task: "Hızlı olan değil, doğru hesaplayan kazanır.", loc: "SDÜ+Spor+Bilimleri+Fakültesi" },
            { id: 7, x: 740, y: 370, name: "SDÜ İlahiyat Fakültesi Durakları", task: "Sabır ve zeka seni bir sonraki hedefe taşıyacak.", loc: "SDÜ+İlahiyat+Fakültesi" },
            { id: 8, x: 675, y: 540, name: "SDÜ Hastanesi Yaşam Cafe", task: "Bir kahve molası tadında bir problem seni bekliyor.", loc: "SDÜ+Hastanesi+Yaşam+Cafe" },
            { id: 9, x: 440, y: 690, name: "SDÜ İİBF", task: "Ekonomik dengeler ve matematiksel gerçekler...", loc: "SDÜ+İİBF" },
            { id: 10, x: 170, y: 650, name: "SDÜ Kulüp Odaları", task: "Sosyal zekanı analitik zekanla harmanla.", loc: "SDÜ+Kulüp+Odaları" }
        ];

        function initPoints() {
            const container = document.getElementById('pts');
            container.innerHTML = '';
            points.forEach(p => {
                const div = document.createElement('div');
                div.className = `map-point ${p.type === 'start' ? 'start' : ''}`;
                div.style.left = p.x + 'px';
                div.style.top = p.y + 'px';
                div.innerHTML = p.type === 'start' ? '<i data-lucide="flag" class="w-3 h-3 text-white"></i>' : p.id;
                
                // Nokta olaylarını iyileştiriyoruz
                div.onpointerdown = (e) => {
                    e.stopPropagation(); // Harita sürükleme motorunu bu eleman için engelle
                };
                
                div.onclick = (e) => {
                    e.stopPropagation();
                    openPointModal(p);
                };
                
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        async function login() {
            const code = document.getElementById('codeIn').value.trim().toUpperCase();
            if(!code) return;
            const { data } = await supabaseClient.from('registrations').select('*').eq('team_code', code).single();
            if(data) {
                team = data;
                document.getElementById('teamN').innerText = team.team_name;
                document.getElementById('loginUI').classList.add('hidden');
                document.getElementById('dashUI').classList.remove('hidden');
                sync();
                supabaseClient.channel('game').on('postgres_changes', { event:'UPDATE', schema:'public', table:'registrations', filter:`id=eq.${team.id}` }, (p) => {
                    team = p.new;
                    sync();
                }).subscribe();
            } else alert('Takım kodu hatalı!');
        }

        function sync() {
            if(timerInt) clearInterval(timerInt);
            const run = team.is_timer_running;
            document.getElementById('wait').classList.toggle('hidden', run);
            document.getElementById('go').classList.toggle('hidden', !run);
            document.getElementById('statL').innerText = run ? 'Yarışıyor' : 'Durduruldu';
            if(run) {
                timerInt = setInterval(() => {
                    const s = Math.floor((Date.now() - new Date(team.timer_started_at).getTime()) / 1000) + Number(team.elapsed_seconds || 0);
                    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
                    document.getElementById('clock').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
                }, 1000);
            }
        }

        // --- HARİTA MOTORU ---
        const vp = document.getElementById('vp'), cv = document.getElementById('canvas'), mi = document.getElementById('mImg');
        mi.onload = resetM;

        function upd() {
            const vw = vp.clientWidth, vh = vp.clientHeight;
            const mw = mi.naturalWidth * sc, mh = mi.naturalHeight * sc;

            if (mw <= vw) tx = (vw - mw) / 2;
            else { if (tx > 0) tx = 0; if (tx < vw - mw) tx = vw - mw; }

            if (mh <= vh) ty = (vh - mh) / 2;
            else { if (ty > 0) ty = 0; if (ty < vh - mh) ty = vh - mh; }

            cv.style.transform = `translate(${tx}px, ${ty}px) scale(${sc})`;
        }

        function zoom(f) { 
            sc = Math.max(minSc, Math.min(6, sc * f)); 
            upd();
        }

        function resetM() { 
            if(!mi.naturalWidth) return;
            minSc = Math.min(vp.clientWidth / mi.naturalWidth, vp.clientHeight / mi.naturalHeight);
            sc = minSc; tx = (vp.clientWidth - mi.naturalWidth * sc) / 2; ty = (vp.clientHeight - mi.naturalHeight * sc) / 2;
            upd(); 
        }

        function setMap(b) { 
            document.getElementById('mapLayer').classList.toggle('open', b); 
            if(b) setTimeout(resetM, 100); 
        }

        vp.onpointerdown = e => { 
            if (sc <= minSc) return; 
            isD = true; sx = e.clientX - tx; sy = e.clientY - ty; 
            vp.setPointerCapture(e.pointerId);
        };

        window.onpointermove = e => { if(isD) { tx = e.clientX - sx; ty = e.clientY - sy; upd(); } };
        window.onpointerup = e => { isD = false; vp.releasePointerCapture(e.pointerId); };
        vp.onwheel = e => { e.preventDefault(); zoom(e.deltaY > 0 ? 0.8 : 1.25); }, { passive: false };

        // --- MODAL YÖNETİMİ ---
        function openPointModal(p) {
            selectedPoint = p;
            document.getElementById('modalPointName').innerText = p.name;
            document.getElementById('pointModal').classList.add('active');
            document.getElementById('btnTask').onclick = () => openScanner(p);
            document.getElementById('btnLoc').onclick = () => showLocation(p);
        }

        function showLocation(p) {
            closeModals();
            const body = document.getElementById('contentBody');
            body.innerHTML = `
                <h3 class="font-black uppercase text-white leading-tight">${p.name}</h3>
                <p class="text-[10px] text-red-500 font-bold uppercase tracking-widest">Sokak Görünümü</p>
                <div class="overflow-hidden rounded-2xl">
                    <iframe class="st-view-iframe" src="https://www.google.com/maps/embed/v1/search?key=&q=${p.loc}&zoom=18"></iframe>
                </div>
            `;
            document.getElementById('contentModal').classList.add('active');
        }

        function openScanner(p) {
            document.getElementById('pointModal').classList.remove('active');
            document.getElementById('qrModal').classList.add('active');
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (d) => { closeScanner(); showTask(p); }, (e) => { });
        }

        function showTask(p) {
            const body = document.getElementById('contentBody');
            body.innerHTML = `
                <div class="p-6 bg-red-600/10 rounded-3xl border border-red-600/20">
                    <h3 class="font-black uppercase text-red-500 text-lg mb-4 leading-tight">${p.name} - GÖREV</h3>
                    <p class="text-white text-sm leading-relaxed font-medium">${p.task}</p>
                </div>
            `;
            document.getElementById('contentModal').classList.add('active');
        }

        function closeScanner() {
            if(html5QrCode) html5QrCode.stop().then(() => document.getElementById('qrModal').classList.remove('active')).catch(() => document.getElementById('qrModal').classList.remove('active'));
            else document.getElementById('qrModal').classList.remove('active');
        }

        function closeModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            selectedPoint = null;
        }

        initPoints();
        lucide.createIcons();
    </script>
</body>
</html>

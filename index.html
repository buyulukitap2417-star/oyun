<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oyun | SDÜ Oryantiring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: white; margin: 0; overflow: hidden; height: 100vh; touch-action: none; user-select: none; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .digital { font-family: 'JetBrains Mono', monospace; text-shadow: 0 0 10px #9b1c31; }
        
        #mapLayer { position: fixed; inset: 0; z-index: 100; background: #020617; transform: translateY(100%); transition: transform 0.5s ease; display: flex; flex-direction: column; }
        #mapLayer.open { transform: translateY(0); }
        #vp { width: 100%; flex-grow: 1; overflow: hidden; position: relative; background: #000; cursor: grab; }
        #canvas { position: absolute; transform-origin: 0 0; will-change: transform; }
        
        .map-point { position: absolute; width: 32px; height: 32px; background: #9b1c31; border: 2px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 11px; transform: translate(-50%, -50%); z-index: 50; }
        .map-point.start { background: #2563eb; }

        /* Telsiz UI */
        #radioBtn { position: fixed; bottom: 24px; right: 24px; z-index: 150; }
        #radioDrawer { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); transform: translateY(100%); transition: transform 0.4s ease; display: flex; flex-direction: column; }
        #radioDrawer.open { transform: translateY(0); }
        .msg-bubble { padding: 10px 14px; border-radius: 16px; font-size: 13px; margin-bottom: 12px; max-width: 80%; }
        .msg-mine { background: #9b1c31; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-admin { background: rgba(255,255,255,0.1); align-self: flex-start; border-bottom-left-radius: 2px; }
    </style>
</head>
<body class="flex flex-col items-center justify-center">

    <!-- GİRİŞ EKRANI -->
    <div id="loginUI" class="fixed inset-0 z-[300] flex items-center justify-center bg-slate-950 px-6">
        <div class="max-w-md w-full glass p-8 rounded-[2.5rem] border-t-4 border-red-700 shadow-2xl text-center">
            <img src="https://r.resimlink.com/p5fEz.png" class="w-20 mx-auto mb-6">
            <h1 class="text-xl font-black uppercase mb-8">YARIŞMACI GİRİŞİ</h1>
            <input type="text" id="codeIn" placeholder="TAKIM KODU" class="w-full bg-black/40 border border-white/10 rounded-xl py-4 px-6 text-center text-xl font-bold outline-none uppercase text-red-500 mb-4 focus:border-red-600">
            <button onclick="login()" class="w-full py-4 bg-red-700 text-white rounded-xl font-black uppercase tracking-widest active:scale-95 transition-all">BAŞLAT</button>
        </div>
    </div>

    <!-- OYUN PANELİ -->
    <div id="dashUI" class="hidden w-full h-full flex flex-col p-4 space-y-4">
        <div class="flex justify-between gap-4">
            <div class="flex-1 glass rounded-2xl p-4">
                <h2 id="teamN" class="text-xs font-black uppercase truncate">---</h2>
                <p id="statL" class="text-[9px] font-bold text-slate-500 uppercase">Hazır</p>
            </div>
            <div class="flex-1 glass rounded-2xl p-4 text-center border-b-2 border-red-700">
                <div id="clock" class="text-2xl font-black digital">00:00:00</div>
                <p class="text-[9px] text-red-500 font-bold uppercase tracking-widest">GÜNCEL SÜRE</p>
            </div>
        </div>

        <div class="flex-1 glass rounded-[2.5rem] flex flex-col items-center justify-center text-center p-8">
            <div id="wait" class="space-y-4">
                <i data-lucide="clock" class="w-16 h-16 text-slate-700 mx-auto"></i>
                <h4 class="text-lg font-black uppercase text-slate-400">YARIŞMA BAŞLATILMADI</h4>
            </div>
            <div id="go" class="hidden space-y-8">
                <div class="w-20 h-20 bg-red-700/10 border-2 border-red-700 rounded-full flex items-center justify-center animate-pulse mx-auto">
                    <i data-lucide="navigation" class="text-red-600"></i>
                </div>
                <button onclick="setMap(true)" class="px-12 py-5 bg-red-700 rounded-2xl font-black uppercase text-xs tracking-widest">HARİTAYI AÇ</button>
            </div>
        </div>
    </div>

    <!-- TELSİZ BUTONU VE ÇEKMECESİ -->
    <button id="radioBtn" onclick="toggleRadio(true)" class="hidden p-5 bg-[#9b1c31] text-white rounded-full shadow-2xl border-4 border-white/10 animate-bounce">
        <i data-lucide="radio"></i>
        <div id="newMsgBadge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-emerald-500 rounded-full border-2 border-[#020617] animate-ping"></div>
    </button>

    <div id="radioDrawer">
        <div class="p-6 border-b border-white/10 flex justify-between items-center bg-white/5">
            <h3 class="font-black uppercase text-sm tracking-widest">MERKEZ TELSİZ HATTI</h3>
            <button onclick="toggleRadio(false)" class="p-2 glass rounded-lg"><i data-lucide="x"></i></button>
        </div>
        <div id="chatBox" class="flex-1 overflow-y-auto p-6 flex flex-col"></div>
        <div class="p-6 border-t border-white/10 flex gap-3">
            <input type="text" id="chatInput" placeholder="Hakeme mesaj yaz..." class="flex-1 bg-white/5 border border-white/10 rounded-xl px-5 py-4 text-sm outline-none focus:border-red-600">
            <button onclick="sendMsg()" class="p-4 bg-red-700 text-white rounded-xl"><i data-lucide="send"></i></button>
        </div>
    </div>

    <!-- HARİTA KATMANI (Noktalar ve Modallar dahil - Önceki koddan referans alınmıştır) -->
    <div id="mapLayer">
        <!-- Harita içeriği buraya gelecek (Noktalar, Zoom motoru vb.) -->
        <div class="p-4 flex justify-between glass border-none"><h2 class="text-xs font-black uppercase">Harita</h2><button onclick="setMap(false)"><i data-lucide="chevron-down"></i></button></div>
        <div id="vp"><div id="canvas"><img id="mImg" src="https://hxdmiamcednlzoklkxnu.supabase.co/storage/v1/object/public/map/map.png" class="pointer-events-none"></div></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://hxdmiamcednlzoklkxnu.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_2lmWYp5Pkvn_BsADVHPKug_KK9n8v2-';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let team = null, timerInt = null, messages = [];

        async function login() {
            const code = document.getElementById('codeIn').value.trim().toUpperCase();
            const { data } = await supabaseClient.from('registrations').select('*').eq('team_code', code).single();
            if(data) {
                team = data;
                document.getElementById('teamN').innerText = team.team_name;
                document.getElementById('loginUI').classList.add('hidden');
                document.getElementById('dashUI').classList.remove('hidden');
                document.getElementById('radioBtn').classList.remove('hidden');
                sync();
                fetchMessages();
                
                // Realtime Kanalları
                supabaseClient.channel('radio').on('postgres_changes', { event:'INSERT', schema:'public', table:'radio_messages' }, (p) => {
                    if(p.new.receiver_id === team.id || p.new.receiver_id === 'all' || p.new.sender_id === team.id) {
                        messages.push(p.new);
                        renderMessages();
                        if(p.new.sender_type === 'admin') document.getElementById('newMsgBadge').classList.remove('hidden');
                    }
                }).subscribe();

                supabaseClient.channel('game').on('postgres_changes', { event:'UPDATE', schema:'public', table:'registrations', filter:`id=eq.${team.id}` }, (p) => {
                    team = p.new; sync();
                }).subscribe();
            }
        }

        function sync() {
            if(timerInt) clearInterval(timerInt);
            const run = team.is_timer_running;
            document.getElementById('wait').classList.toggle('hidden', run);
            document.getElementById('go').classList.toggle('hidden', !run);
            if(run) {
                timerInt = setInterval(() => {
                    const s = Math.floor((Date.now() - new Date(team.timer_started_at).getTime()) / 1000) + Number(team.elapsed_seconds || 0);
                    const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
                    document.getElementById('clock').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
                }, 1000);
            }
        }

        function toggleRadio(b) { 
            document.getElementById('radioDrawer').classList.toggle('open', b);
            if(b) document.getElementById('newMsgBadge').classList.add('hidden');
        }

        async function fetchMessages() {
            const { data } = await supabaseClient.from('radio_messages').select('*').or(`receiver_id.eq.${team.id},receiver_id.eq.all,sender_id.eq.${team.id}`).order('created_at', { ascending: true });
            if(data) { messages = data; renderMessages(); }
        }

        function renderMessages() {
            const box = document.getElementById('chatBox');
            box.innerHTML = messages.map(m => {
                const isMine = m.sender_type === 'team';
                return `
                    <div class="flex flex-col ${isMine ? 'items-end' : 'items-start'} mb-4">
                        <div class="msg-bubble ${isMine ? 'msg-mine' : 'msg-admin'}">
                            <div class="text-[9px] font-black uppercase mb-1 opacity-50">${m.sender_name}</div>
                            <div class="font-bold">${m.content}</div>
                        </div>
                    </div>
                `;
            }).join('');
            box.scrollTop = box.scrollHeight;
        }

        async function sendMsg() {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            if(!content) return;
            await supabaseClient.from('radio_messages').insert({
                sender_type: 'team',
                sender_id: team.id,
                receiver_id: 'admin',
                sender_name: team.team_name,
                content: content
            });
            input.value = '';
        }

        function setMap(b) { document.getElementById('mapLayer').classList.toggle('open', b); }
        lucide.createIcons();
    </script>
</body>
</html>

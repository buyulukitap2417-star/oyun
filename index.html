<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oyun | SDÜ Oryantiring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: white; margin: 0; overflow: hidden; height: 100vh; touch-action: none; }
        .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .digital { font-family: 'JetBrains Mono', monospace; text-shadow: 0 0 10px #9b1c31; }
        #mapLayer { position: fixed; inset: 0; z-index: 100; background: #020617; transform: translateY(100%); transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        #mapLayer.open { transform: translateY(0); }
        #vp { width: 100%; flex-grow: 1; overflow: hidden; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        #canvas { position: absolute; transform-origin: center center; will-change: transform; pointer-events: auto; }
        .map-point { position: absolute; width: 44px; height: 44px; background: #9b1c31; border: 3px solid white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 15px; transform: translate(-50%, -50%); z-index: 50; box-shadow: 0 0 25px rgba(155, 28, 49, 0.7); }
        .map-point.start { background: #2563eb; }
        .zoom-controls { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 10px; z-index: 120; }
        .zoom-btn { width: 50px; height: 50px; background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; display: flex; align-items: center; justify-content: center; }
        .control-btn { transition: all 0.3s; width: 64px; height: 64px; border-radius: 1.5rem; display: flex; align-items: center; justify-content: center; border: 2.5px solid rgba(255,255,255,0.1); }
        .btn-active { background: #ef4444 !important; animation: pulse 1.5s infinite; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); backdrop-filter: blur(12px); z-index: 200; display: none; align-items: center; justify-content: center; padding: 1.5rem; }
        .modal-overlay.active { display: flex; }
    </style>
</head>
<body class="flex flex-col items-center justify-center">

    <div id="loader" class="fixed inset-0 z-[500] bg-[#020617] flex items-center justify-center"><div class="w-12 h-12 border-4 border-red-700 border-t-transparent rounded-full animate-spin"></div></div>
    <audio id="remoteAudio" autoplay class="hidden"></audio>

    <div id="loginUI" class="fixed inset-0 z-[300] flex items-center justify-center bg-slate-950 px-6 text-white text-center">
        <div class="max-w-md w-full glass p-10 rounded-[3rem] border-t-4 border-red-700 shadow-2xl">
            <img src="https://r.resimlink.com/p5fEz.png" class="w-24 mx-auto mb-6">
            <h1 class="text-3xl font-black uppercase mb-10">YARIŞMACI</h1>
            <input type="text" id="codeIn" placeholder="TAKIM KODU" class="w-full bg-black/40 border border-white/10 rounded-2xl py-6 px-6 text-center text-3xl font-black outline-none uppercase text-red-500 mb-6 focus:border-red-600 transition-all">
            <button onclick="login()" class="w-full py-6 bg-red-700 text-white rounded-2xl font-black uppercase tracking-widest shadow-lg">BAŞLAT</button>
        </div>
    </div>

    <div id="dashUI" class="hidden w-full h-full flex flex-col p-4 space-y-4">
        <div class="flex justify-between gap-3">
            <div class="flex-1 glass rounded-2xl p-5 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-red-700"></div>
                <h2 id="teamN" class="text-xs font-black uppercase truncate pr-6 text-left">---</h2>
                <div class="flex items-center gap-2 mt-2"><div id="gpsStatus" class="w-2 h-2 bg-slate-600 rounded-full"></div><p id="gpsText" class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">GPS Bekleniyor</p></div>
                <button onclick="logout()" class="absolute top-5 right-5 text-slate-500"><i data-lucide="log-out" class="w-4 h-4"></i></button>
            </div>
            <div class="flex-1 glass rounded-2xl p-5 text-center border-b-4 border-red-700">
                <div id="clock" class="text-3xl font-black digital">00:00:00</div>
                <p class="text-[9px] text-red-500 font-bold uppercase mt-1">YARIŞMA SÜRESİ</p>
            </div>
        </div>
        <div class="flex-1 glass rounded-[3rem] flex flex-col items-center justify-center text-center p-8 border border-white/5">
            <div id="wait" class="space-y-6"><i data-lucide="timer" class="w-12 h-12 text-slate-700 animate-pulse mx-auto"></i><h4 class="text-xl font-black uppercase text-slate-400">BAŞLANGIÇ BEKLENİYOR</h4></div>
            <div id="go" class="hidden space-y-10"><i data-lucide="map" class="text-red-600 w-12 h-12 mx-auto animate-pulse"></i><button onclick="setMap(true)" class="px-16 py-6 bg-red-700 rounded-2xl font-black uppercase text-sm tracking-[0.3em] text-white shadow-2xl">HARİTAYI AÇ</button></div>
        </div>
    </div>

    <div id="voiceUI" class="hidden fixed bottom-10 right-10 z-[150] flex flex-col gap-4">
        <button id="spkBtn" onclick="toggleSpk()" class="control-btn btn-muted shadow-3xl"><i data-lucide="volume-x" id="spkIcon" class="text-white w-7 h-7"></i></button>
        <button id="micBtn" onclick="toggleMic()" class="control-btn btn-muted shadow-3xl"><i data-lucide="mic-off" id="micIcon" class="text-white w-7 h-7"></i></button>
    </div>

    <div id="mapLayer">
        <div class="p-6 flex justify-between items-center glass border-none bg-slate-900/70 backdrop-blur-3xl text-white">
            <div class="flex items-center gap-3"><i data-lucide="map" class="text-red-600 w-5 h-5"></i><h2 class="font-black text-xs uppercase tracking-widest">DİJİTAL HARİTA</h2></div>
            <button onclick="setMap(false)" class="p-4 bg-white/5 rounded-2xl"><i data-lucide="chevron-down"></i></button>
        </div>
        <div id="vp">
            <div class="zoom-controls">
                <button onclick="zoom(1.5)" class="zoom-btn"><i data-lucide="plus"></i></button>
                <button onclick="resetM()" class="zoom-btn"><i data-lucide="maximize-2"></i></button>
                <button onclick="zoom(0.6)" class="zoom-btn"><i data-lucide="minus"></i></button>
            </div>
            <div id="canvas"><img id="mImg" src="https://hxdmiamcednlzoklkxnu.supabase.co/storage/v1/object/public/map/map.png" class="pointer-events-none" alt="Map"><div id="pts" class="pointer-events-auto"></div></div>
        </div>
    </div>

    <div id="pointModal" class="modal-overlay text-white"><div class="glass w-full max-w-sm p-10 rounded-[3.5rem] text-center space-y-8"><h3 id="modalPointName" class="text-xl font-black uppercase">---</h3><div class="space-y-4"><button id="btnTask" class="w-full py-6 bg-red-700 text-white rounded-3xl font-black text-xs uppercase flex items-center justify-center gap-3 shadow-xl"><i data-lucide="qr-code"></i> QR OKUT</button><button id="btnLoc" class="w-full py-6 glass border border-white/10 rounded-3xl text-xs uppercase font-bold flex items-center justify-center gap-3"><i data-lucide="eye"></i> KONUM</button><button onclick="closeModals()" class="w-full py-2 text-slate-500 uppercase font-black text-[10px]">KAPAT</button></div></div></div>
    <div id="qrModal" class="modal-overlay text-white"><div class="glass w-full max-w-md p-6 rounded-[3rem] text-center border-t-4 border-red-700 shadow-3xl"><h3 class="text-xs font-black mb-6 uppercase tracking-widest">HEDEF QR OKUTUN</h3><div id="reader" class="rounded-3xl overflow-hidden border-4 border-black"></div><button onclick="closeScanner()" class="mt-8 w-full py-5 glass border border-red-900/30 text-red-500 font-bold uppercase text-xs rounded-2xl">VAZGEÇ</button></div></div>
    <div id="contentModal" class="modal-overlay text-white"><div class="glass w-full max-w-lg p-8 rounded-[3.5rem] text-center relative border-t-4 border-emerald-500 shadow-3xl"><button onclick="closeModals()" class="absolute top-6 right-6 text-slate-500"><i data-lucide="x"></i></button><div id="contentBody" class="mt-4 space-y-6"></div></div></div>

    <script>
        const SUPABASE_URL = 'https://hxdmiamcednlzoklkxnu.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_2lmWYp5Pkvn_BsADVHPKug_KK9n8v2-';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let team = null, timerInt = null, peer = null, myStream = null, micOn = false, spkOn = false;
        let sc = 1, minSc = 1, tx = 0, ty = 0, isD = false, sx, sy, lastLat = null, lastLng = null;

        const points = [
            { id: 0, x: 475, y: 320, name: "Eğitim Fakültesi", type: "start", secret: "START_POINT", embed: "https://www.google.com/maps/embed?pb=!4v1771617689736!6m8!1m7!1sRO-U8WGElZ3Py_Ecp1CKBA!2m2!1d37.83084480198436!2d30.53590397797262!3f158.10045157168938!4f-0.05794305684364076!5f0.4000000000000002" },
            { id: 1, x: 222, y: 220, name: "Yüzme Havuzu", secret: "POINT_1", embed: "https://www.google.com/maps/embed?pb=!4v1771617737459!6m8!1m7!1seBYXHNUGftz0PO15pjIsgA!2m2!1d37.83222186624993!2d30.53236500664342!3f95.09038325697996!4f-5.134908572958537!5f0.4000000000000002" },
            { id: 2, x: 590, y: 210, name: "Orman Fakültesi", secret: "POINT_2", embed: "https://www.google.com/maps/embed?pb=!4v1771617823918!6m8!1m7!1siZhN5Nv-r-h3hxI3W1mfKQ!2m2!1d37.83211746106197!2d30.53754298522506!3f126.67348552797063!4f5.166187979327333!5f0.4000000000000002" },
            { id: 3, x: 200, y: 520, name: "Bilgi Merkezi", secret: "POINT_3", embed: "https://www.google.com/maps/embed?pb=!4v1771617924715!6m8!1m7!1sExYVwsM4RdVnKU0uRJj0Vw!2m2!1d37.82818812592497!2d30.53224474946234!3f346.4197002666084!4f-0.5840344576972711!5f0.4000000000000002" },
            { id: 4, x: 410, y: 450, name: "Academi Yaşam", secret: "POINT_4", embed: "https://www.google.com/maps/embed?pb=!4v1771617901489!6m8!1m7!1sfHdiGDOl_9j3qBDXUq1Hsg!2m2!1d37.82937176700175!2d30.53426187517274!3f20.379486408347063!4f1.3607931673231661!5f0.7820865974627469" },
            { id: 5, x: 490, y: 530, name: "Doğu Durakları", secret: "POINT_5", embed: "https://www.google.com/maps/embed?pb=!4v1771618062791!6m8!1m7!1shM0pNAKrTLqDxdtc1hYUyg!2m2!1d37.82851589332846!2d30.53640783067043!3f206.6784605769838!4f3.36776164427377!5f0.4000000000000002" },
            { id: 6, x: 375, y: 285, name: "Spor Bilimleri", secret: "POINT_6", embed: "https://www.google.com/maps/embed?pb=!4v1771617770097!6m8!1m7!1sc9XXggbNQi0Yx2dA-kU9pw!2m2!1d37.83117660022433!2d30.53445828913934!3f33.28225217166947!4f1.9919576983564724!5f0.4000000000000002" },
            { id: 7, x: 740, y: 370, name: "İlahiyat Durakları", secret: "POINT_7", embed: "https://www.google.com/maps/embed?pb=!4v1771617872056!6m8!1m7!1sJx9yem-pjeR7Wc_7G-Ew5g!2m2!1d37.82991888681035!2d30.53919883634785!3f30.193196586987977!4f-2.9730351787111005!5f0.4000000000000002" },
            { id: 8, x: 675, y: 540, name: "Yaşam Cafe", secret: "POINT_8", embed: "https://www.google.com/maps/embed?pb=!4v1771617989304!6m8!1m7!1s2uz-6qNzGXBflBQxAe69Xw!2m2!1d37.82821271069792!2d30.53881902284264!3f91.93654445552963!4f-3.4669365772635103!5f0.4000000000000002" },
            { id: 9, x: 440, y: 690, name: "İİBF", secret: "POINT_9", embed: "https://www.google.com/maps/embed?pb=!4v1771617959900!6m8!1m7!1sYLl0RJWEdH1jPKEZi0Z2hQ!2m2!1d37.82650566961525!2d30.53528759897594!3f116.46149291944955!4f5.666874545602823!5f0.4000000000000002" },
            { id: 10, x: 170, y: 650, name: "Kulüp Odaları", secret: "POINT_10", embed: "https://www.google.com/maps/embed?pb=!4v1771618029704!6m8!1m7!1sPbZKPRv7M-zo6S4l7z8hYA!2m2!1d37.82785271437022!2d30.53077925418662!3f48.440361512346335!4f-2.942266211748219!5f0.4000000000000002" }
        ];

        window.onload = async () => {
            lucide.createIcons(); const saved = localStorage.getItem('sdu_team_code');
            if(saved) { document.getElementById('codeIn').value = saved; await login(); }
            document.getElementById('loader').style.opacity = '0'; setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
        };

        async function login() {
            const c = document.getElementById('codeIn').value.trim().toUpperCase(); if(!c) return;
            const { data } = await supabaseClient.from('registrations').select('*').eq('team_code', c).single();
            if(data) {
                team = data; localStorage.setItem('sdu_team_code', c);
                document.getElementById('teamN').innerText = team.team_name;
                document.getElementById('loginUI').classList.add('hidden'); document.getElementById('dashUI').classList.remove('hidden'); document.getElementById('voiceUI').classList.remove('hidden');
                initPoints(); sync(); startVoice(); startGPS();
                supabaseClient.channel('game_up').on('postgres_changes', {event:'UPDATE', schema:'public', table:'registrations', filter:`id=eq.${team.id}`}, (p) => { team = p.new; sync(); }).subscribe();
            } else { alert("Kod Hatalı!"); localStorage.removeItem('sdu_team_code'); }
        }

        function startGPS() {
            navigator.geolocation.watchPosition(async (pos) => {
                const { latitude: lat, longitude: lng } = pos.coords;
                document.getElementById('gpsStatus').className = "w-2 h-2 bg-emerald-500 rounded-full animate-pulse";
                document.getElementById('gpsText').innerText = "GPS AKTİF"; document.getElementById('gpsText').classList.replace('text-slate-500', 'text-emerald-500');
                if(team.is_timer_running) {
                    const dist = lastLat ? Math.sqrt(Math.pow(lat-lastLat,2)+Math.pow(lng-lastLng,2)) : 1;
                    if(dist > 0.0001) { lastLat = lat; lastLng = lng; const hist = [...(team.path_history || []), {lat, lng, time: new Date().toISOString()}].slice(-100);
                        await supabaseClient.from('registrations').update({last_lat:lat, last_lng:lng, path_history:hist}).eq('id', team.id); }
                }
            }, null, {enableHighAccuracy: true});
        }

        async function startVoice() {
            peer = new Peer('SDU_TEAM_' + team.id.substring(0,8));
            peer.on('open', async () => {
                try { myStream = await navigator.mediaDevices.getUserMedia({audio:true}); myStream.getAudioTracks()[0].enabled = false;
                    const call = peer.call('SDU_ADMIN_2026_VOICE', myStream); call.on('stream', (rs) => { document.getElementById('remoteAudio').srcObject = rs; });
                } catch(e) {}
            });
        }
        function toggleMic() { if(!myStream) return; micOn = !micOn; myStream.getAudioTracks()[0].enabled = micOn; upUI(); }
        function toggleSpk() { spkOn = !spkOn; document.getElementById('remoteAudio').muted = !spkOn; upUI(); }
        function upUI() {
            document.getElementById('micBtn').className = micOn ? "control-btn btn-active shadow-2xl" : "control-btn btn-muted shadow-2xl";
            document.getElementById('micIcon').setAttribute('data-lucide', micOn ? 'mic' : 'mic-off');
            document.getElementById('spkBtn').className = spkOn ? "control-btn btn-active shadow-2xl" : "control-btn btn-muted shadow-2xl";
            document.getElementById('spkIcon').setAttribute('data-lucide', spkOn ? 'volume-2' : 'volume-x');
            lucide.createIcons();
        }

        const vp = document.getElementById('vp'), cv = document.getElementById('canvas'), mi = document.getElementById('mImg');
        mi.onload = resetM; window.onresize = resetM;
        function upd() { cv.style.transform = `translate(${tx}px, ${ty}px) scale(${sc})`; }
        function zoom(f) { sc = Math.max(minSc, Math.min(6, sc * f)); upd(); }
        function resetM() { if(!mi.naturalWidth) return; minSc = Math.min(vp.clientWidth/mi.naturalWidth, vp.clientHeight/mi.naturalHeight); sc = minSc; tx = 0; ty = 0; upd(); }
        function setMap(b) { document.getElementById('mapLayer').classList.toggle('open', b); if(b) setTimeout(resetM, 100); }
        vp.onpointerdown = e => { isD = true; sx = e.clientX-tx; sy = e.clientY-ty; vp.setPointerCapture(e.pointerId); };
        window.onpointermove = e => { if(isD) { tx = e.clientX-sx; ty = e.clientY-sy; upd(); } };
        window.onpointerup = e => { isD = false; vp.releasePointerCapture(e.pointerId); };

        function initPoints() {
            const container = document.getElementById('pts'); container.innerHTML = '';
            points.forEach(p => {
                const div = document.createElement('div'); div.className = `map-point ${p.type === 'start' ? 'start' : ''}`;
                div.style.left = p.x + 'px'; div.style.top = p.y + 'px'; div.innerHTML = p.type === 'start' ? '<i data-lucide="flag" class="w-4 h-4 text-white"></i>' : p.id;
                div.onpointerdown = e => e.stopPropagation(); div.onclick = e => { e.stopPropagation(); openPointModal(p); };
                container.appendChild(div);
            });
            lucide.createIcons();
        }
        function openPointModal(p) {
            selectedPoint = p; document.getElementById('modalPointName').innerText = p.name;
            document.getElementById('pointModal').classList.add('active');
            document.getElementById('btnTask').onclick = () => openScanner();
            document.getElementById('btnLoc').onclick = () => { closeModals(); document.getElementById('contentBody').innerHTML = `<iframe class="st-view-iframe" src="${p.embed}"></iframe>`; document.getElementById('contentModal').classList.add('active'); };
        }
        let hs = null;
        function openScanner() {
            document.getElementById('pointModal').classList.remove('active'); document.getElementById('qrModal').classList.add('active');
            hs = new Html5Qrcode("reader"); hs.start({facingMode:"environment"}, {fps:10, qrbox:250}, (d) => {
                if(d === selectedPoint.secret) { hs.stop().then(() => { document.getElementById('qrModal').classList.remove('active'); showTask(selectedPoint); }); }
                else alert("Hatalı QR!");
            }, null);
        }
        function showTask(p) { document.getElementById('contentBody').innerHTML = `<div class="p-8 bg-emerald-500/10 rounded-[3rem] border border-emerald-500/20 text-left"><h3 class="text-white font-black text-xl mb-4 uppercase">${p.name}</h3><p class="text-white text-sm italic">${p.task}</p></div>`; document.getElementById('contentModal').classList.add('active'); lucide.createIcons(); }
        function closeScanner() { if(hs) hs.stop().then(() => document.getElementById('qrModal').classList.remove('active')); else document.getElementById('qrModal').classList.remove('active'); }
        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); }
        function sync() {
            if(timerInt) clearInterval(timerInt);
            if(team.is_timer_running) timerInt = setInterval(() => { const s = Math.floor((Date.now() - new Date(team.timer_started_at).getTime()) / 1000) + Number(team.elapsed_seconds || 0); renderTime(s); }, 1000);
            else renderTime(team.elapsed_seconds || 0);
            document.getElementById('wait').classList.toggle('hidden', team.is_timer_running); document.getElementById('go').classList.toggle('hidden', !team.is_timer_running);
        }
        function renderTime(s) { document.getElementById('clock').innerText = `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor((s%3600)/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
        function logout() { localStorage.removeItem('sdu_team_code'); location.reload(); }
    </script>
</body>
</html>
